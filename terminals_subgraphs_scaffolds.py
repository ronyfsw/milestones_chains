from modules.config import *
run_dir_path = os.path.join(os.getcwd(), 'run_dir')
sub_graphs_path = os.path.join(run_dir_path, 'sub_graphs')
sub_graphs_files = os.listdir(sub_graphs_path)
scaffolds_path = os.path.join(run_dir_path, 'scaffolds')
scaffolds_files = os.listdir(scaffolds_path)
scaffolds_indices = [re.findall('\d{1,}', file)[0] for file in scaffolds_files]
scaffolds_dict = dict(zip(scaffolds_indices, scaffolds_files))

nodes_decoder = np.load(os.path.join(run_dir_path, 'nodes_decoder.npy'), allow_pickle=True)[()]
nodes_encoder = np.load(os.path.join(run_dir_path, 'nodes_encoder.npy'), allow_pickle=True)[()]

sub_graphs_sizes = []
missing_terminals = ['MI20-EMS-N2-62570', 'MI20-EMS-N2-61810', 'MI20-EMS-N2-62040', 'MI20-EMS-N2-62340', 'MI20-EMS-N2-60500', 'MI20-EMS-N2-120608', 'MI20-EMS-N2-120648', 'MI20-EMS-N2-528281', 'MI20-EMS-N2-60660', 'MI20-EMS-N2-120319', 'MI20-EMS-N2-61910', 'MI20-EMS-N2-60940', 'MI20-EMS-N2-72050', 'MI20-EMS-N2-521030', 'MI20-EMS-N2-527933', 'MI20-EMS-N2-61510', 'MI20-EMS-N2-98712', 'MI20-EMS-N2-62320', 'MI20-EMS-N2-527881', 'MI20-EMS-N2-61570', 'MI20-EMS-N2-62550', 'MI20-EMS-N2-60680', 'MI20-EMS-N2-98142', 'MI20-EMS-N2-62790', 'MI20-EMS-N2-62910', 'MI20-EMS-N2-116790', 'MI20-EMS-N2-94520', 'MI20-EMS-N2-60480', 'MI20-EMS-N2-61670', 'MI20-EMS-N2-300192', 'MI20-EMS-N2-60460', 'MI20-EMS-N2-112540', 'MI20-EMS-N2-600502', 'MI20-EMS-N2-116452', 'MI20-EMS-N2-61470', 'MI20-EMS-N2-528341', 'MI20-EMS-N2-94910', 'MI20-EMS-N2-61750', 'MI20-EMS-N2-603662', 'MI20-EMS-N2-71760', 'MI20-EMS-N2-114760', 'MI20-EMS-N2-62510', 'MI20-EMS-N2-62990', 'MI20-EMS-N2-62360', 'MI20-EMS-N2-61710', 'MI20-EMS-N2-61020', 'MI20-EMS-N2-96450', 'MI20-EMS-N2-121098', 'MI20-EMS-N2-600302', 'MI20-EMS-N2-62610', 'MI20-EMS-N2-60920', 'MI20-EMS-N2-60640', 'MI20-EMS-N2-63130', 'MI20-EMS-N2-62930', 'MI20-EMS-N2-63030', 'MI20-EMS-N2-61550', 'MI20-EMS-N2-60900', 'MI20-EMS-N2-62850', 'MI20-EMS-N2-60440', 'MI20-EMS-N2-61590', 'MI20-EMS-N2-62630', 'MI20-EMS-N2-61000', 'MI20-EMS-N2-61970', 'MI20-EMS-N2-63010', 'MI20-EMS-N2-62810', 'MI20-EMS-N2-61630', 'MI20-EMS-N2-63070', 'MI20-EMS-N2-61930', 'MI20-EMS-N2-521310', 'MI20-EMS-N2-62670', 'MI20-EMS-N2-61890', 'MI20-EMS-N2-60520', 'MI20-EMS-N2-300257', 'MI20-EMS-N2-62830', 'MI20-EMS-N2-300211', 'MI20-EMS-N2-62870', 'MI20-EMS-N2-61990', 'MI20-EMS-N2-62150', 'MI20-EMS-N2-94964', 'MI20-EMS-N2-61450', 'MI20-EMS-N2-62970', 'MI20-EMS-N2-60860', 'MI20-EMS-N2-520678', 'MI20-EMS-N2-62130', 'MI20-EMS-N2-525840', 'MI20-EMS-N2-62380', 'MI20-EMS-N2-62210', 'MI20-EMS-N2-111288', 'MI20-EMS-N2-62270', 'MI20-EMS-N2-61730', 'MI20-EMS-N2-61870', 'MI20-EMS-N2-60580', 'MI20-EMS-N2-61830', 'MI20-EMS-N2-62110', 'MI20-EMS-N2-61950', 'MI20-EMS-N2-60820', 'MI20-EMS-N2-120568', 'MI20-EMS-N2-60780', 'MI20-EMS-N2-60720', 'MI20-EMS-N2-61490', 'MI20-EMS-N2-527963', 'MI20-EMS-N2-110530', 'MI20-EMS-N2-62300', 'MI20-EMS-N2-94630', 'MI20-EMS-N2-603462', 'MI20-EMS-N2-60600', 'MI20-EMS-N2-62710', 'MI20-EMS-N2-111330', 'MI20-EMS-N2-62470', 'MI20-EMS-N2-62690', 'MI20-EMS-N2-120549', 'MI20-EMS-N2-62250', 'MI20-EMS-N2-61650', 'MI20-EMS-N2-61770', 'MI20-EMS-N2-528251', 'MI20-EMS-N2-521260', 'MI20-EMS-N2-63090', 'MI20-EMS-N2-61530', 'MI20-EMS-N2-120768', 'MI20-EMS-N2-61690', 'MI20-EMS-N2-63050', 'MI20-EMS-N2-60540', 'MI20-EMS-N2-62230', 'MI20-EMS-N2-120558', 'MI20-EMS-N2-61850', 'MI20-EMS-N2-94850', 'MI20-EMS-N2-72160', 'MI20-EMS-N2-62750', 'MI20-EMS-N2-60760', 'MI20-EMS-N2-61610', 'MI20-EMS-N2-62490', 'MI20-EMS-N2-60740', 'MI20-EMS-N2-60560', 'MI20-EMS-N2-61790', 'MI20-EMS-N2-71780', 'MI20-EMS-N2-60800', 'MI20-EMS-N2-62730', 'MI20-EMS-N2-63100', 'MI20-EMS-N2-71950', 'MI20-EMS-N2-60840', 'MI20-EMS-N2-60700', 'MI20-EMS-N2-120362', 'MI20-EMS-N2-62190', 'MI20-EMS-N2-60620', 'MI20-EMS-N2-603562', 'MI20-EMS-N2-62590', 'MI20-EMS-N2-62170', 'MI20-EMS-N2-111834', 'MI20-EMS-N2-120688', 'MI20-EMS-N2-522130', 'MI20-EMS-N2-111740', 'MI20-EMS-N2-62400', 'MI20-EMS-N2-98724', 'MI20-EMS-N2-60980', 'MI20-EMS-N2-63120', 'MI20-EMS-N2-61440', 'MI20-EMS-N2-98110', 'MI20-EMS-N2-63080', 'MI20-EMS-N2-72260', 'MI20-EMS-N2-527903', 'MI20-EMS-N2-72360', 'MI20-EMS-N2-62430', 'MI20-EMS-N2-600402', 'MI20-EMS-N2-120395', 'MI20-EMS-N2-62450', 'MI20-EMS-N2-115830', 'MI20-EMS-N2-71790', 'MI20-EMS-N2-62530', 'MI20-EMS-N2-120728', 'MI20-EMS-N2-62770', 'MI20-EMS-N2-62890', 'MI20-EMS-N2-62950', 'MI20-EMS-N2-60880', 'MI20-EMS-N2-62100', 'MI20-EMS-N2-923291', 'MI20-EMS-N2-71810', 'MI20-EMS-N2-60960', 'MI20-EMS-N2-115894', 'MI20-EMS-N2-62650', 'MI20-EMS-N2-528311']
missing_terminals_predecessors = ['MI20-EMS-N2-120360', 'MI20-EMS-N2-120361', 'MI20-EMS-N2-62240', 'MI20-EMS-N2-61880', 'MI20-EMS-N2-94576', 'MI20-EMS-N2-120318', 'MI20-EMS-N2-60770', 'MI20-EMS-N2-62700', 'MI20-EMS-N2-61900', 'MI20-EMS-N2-60870', 'MI20-EMS-N2-61780', 'MI20-EMS-N2-62620', 'MI20-EMS-N2-120393', 'MI20-EMS-N2-527751', 'MI20-EMS-N2-120438', 'MI20-EMS-N2-60950', 'MI20-EMS-N2-62280', 'MI20-EMS-N2-60590', 'MI20-EMS-N2-61580', 'MI20-EMS-N2-61220', 'MI20-EMS-N2-62500', 'MI20-EMS-N2-62200', 'MI20-EMS-N2-61680', 'MI20-EMS-N2-63000', 'MI20-EMS-N2-71750', 'MI20-EMS-N2-61660', 'MI20-EMS-N2-528241', 'MI20-EMS-N2-98704', 'MI20-EMS-N2-62160', 'MI20-EMS-N2-61980', 'MI20-EMS-N2-60490', 'MI20-EMS-N2-72302', 'MI20-EMS-N2-72340', 'MI20-EMS-N2-60690', 'MI20-EMS-N2-94954', 'MI20-EMS-N2-98141', 'MI20-EMS-N2-63060', 'MI20-EMS-N2-60750', 'MI20-EMS-N2-522120', 'MI20-EMS-N2-61010', 'MI20-EMS-N2-61500', 'MI20-EMS-N2-61740', 'MI20-EMS-N2-603452', 'MI20-EMS-N2-94840', 'MI20-EMS-N2-62980', 'MI20-EMS-N2-62560', 'MI20-EMS-N2-62410', 'MI20-EMS-N2-61220', 'MI20-EMS-N2-60970', 'MI20-EMS-N2-60710', 'MI20-EMS-N2-62350', 'MI20-EMS-N2-115812', 'MI20-EMS-N2-60670', 'MI20-EMS-N2-62060', 'MI20-EMS-N2-300208', 'MI20-EMS-N2-62540', 'MI20-EMS-N2-62580', 'MI20-EMS-N2-60990', 'MI20-EMS-N2-111286', 'MI20-EMS-N2-300247', 'MI20-EMS-N2-62880', 'MI20-EMS-N2-60790', 'MI20-EMS-N2-60570', 'MI20-EMS-N2-61840', 'MI20-EMS-N2-521250', 'MI20-EMS-N2-60530', 'MI20-EMS-N2-62760', 'MI20-EMS-N2-62740', 'MI20-EMS-N2-111328', 'MI20-EMS-N2-61148', 'MI20-EMS-N2-116403', 'MI20-EMS-N2-61220', 'MI20-EMS-N2-300182', 'MI20-EMS-N2-62920', 'MI20-EMS-N2-111336', 'MI20-EMS-N2-62120', 'MI20-EMS-N2-71740', 'MI20-EMS-N2-60810', 'MI20-EMS-N2-600292', 'MI20-EMS-N2-61600', 'MI20-EMS-N2-60510', 'MI20-EMS-N2-120618', 'MI20-EMS-N2-120638', 'MI20-EMS-N2-60450', 'MI20-EMS-N2-62780', 'MI20-EMS-N2-62310', 'MI20-EMS-N2-61820', 'MI20-EMS-N2-60730', 'MI20-EMS-N2-61030', 'MI20-EMS-N2-98092', 'MI20-EMS-N2-525810', 'MI20-EMS-N2-120738', 'MI20-EMS-N2-120758', 'MI20-EMS-N2-60610', 'MI20-EMS-N2-527751', 'MI20-EMS-N2-94510', 'MI20-EMS-N2-63040', 'MI20-EMS-N2-61720', 'MI20-EMS-N2-62820', 'MI20-EMS-N2-96432', 'MI20-EMS-N2-521300', 'MI20-EMS-N2-62390', 'MI20-EMS-N2-111833', 'MI20-EMS-N2-600492', 'MI20-EMS-N2-62720', 'MI20-EMS-N2-62440', 'MI20-EMS-N2-61460', 'MI20-EMS-N2-528241', 'MI20-EMS-N2-62330', 'MI20-EMS-N2-62260', 'MI20-EMS-N2-72040', 'MI20-EMS-N2-120357', 'MI20-EMS-N2-60470', 'MI20-EMS-N2-61700', 'MI20-EMS-N2-603552', 'MI20-EMS-N2-62370', 'MI20-EMS-N2-62860', 'MI20-EMS-N2-527751', 'MI20-EMS-N2-62840', 'MI20-EMS-N2-61640', 'MI20-EMS-N2-120548', 'MI20-EMS-N2-62000', 'MI20-EMS-N2-60850', 'MI20-EMS-N2-61540', 'MI20-EMS-N2-62900', 'MI20-EMS-N2-60930', 'MI20-EMS-N2-61620', 'MI20-EMS-N2-528241', 'MI20-EMS-N2-61940', 'MI20-EMS-N2-61430', 'MI20-EMS-N2-60890', 'MI20-EMS-N2-62420', 'MI20-EMS-N2-72102', 'MI20-EMS-N2-72140', 'MI20-EMS-N2-120658', 'MI20-EMS-N2-120678', 'MI20-EMS-N2-62660', 'MI20-EMS-N2-62460', 'MI20-EMS-N2-521022', 'MI20-EMS-N2-62600', 'MI20-EMS-N2-62140', 'MI20-EMS-N2-61960', 'MI20-EMS-N2-923281', 'MI20-EMS-N2-61800', 'MI20-EMS-N2-60910', 'MI20-EMS-N2-61220', 'MI20-EMS-N2-600392', 'MI20-EMS-N2-60830', 'MI20-EMS-N2-62180', 'MI20-EMS-N2-62940', 'MI20-EMS-N2-61230', 'MI20-EMS-N2-63020', 'MI20-EMS-N2-61860', 'MI20-EMS-N2-62680', 'MI20-EMS-N2-527751', 'MI20-EMS-N2-62520', 'MI20-EMS-N2-71800', 'MI20-EMS-N2-520669', 'MI20-EMS-N2-116772', 'MI20-EMS-N2-61520', 'MI20-EMS-N2-94576', 'MI20-EMS-N2-114540', 'MI20-EMS-N2-115892', 'MI20-EMS-N2-61920', 'MI20-EMS-N2-112516', 'MI20-EMS-N2-98722', 'MI20-EMS-N2-60650', 'MI20-EMS-N2-61230', 'MI20-EMS-N2-62640', 'MI20-EMS-N2-62480', 'MI20-EMS-N2-60550', 'MI20-EMS-N2-62960', 'MI20-EMS-N2-61760', 'MI20-EMS-N2-71770', 'MI20-EMS-N2-72250', 'MI20-EMS-N2-61480', 'MI20-EMS-N2-120578', 'MI20-EMS-N2-120598', 'MI20-EMS-N2-120698', 'MI20-EMS-N2-120718', 'MI20-EMS-N2-603652', 'MI20-EMS-N2-60630', 'MI20-EMS-N2-110531', 'MI20-EMS-N2-71940', 'MI20-EMS-N2-61560', 'MI20-EMS-N2-62220', 'MI20-EMS-N2-528241', 'MI20-EMS-N2-62800']

for sub_graphs_file in sub_graphs_files:
    # Read and decode sub graph nodes
    sub_graph_path = os.path.join(sub_graphs_path, sub_graphs_file)
    sub_graph = nx.read_edgelist(sub_graph_path, create_using=nx.DiGraph)
    encoded_nodes = list(sub_graph.nodes())
    sub_graph_tasks = [nodes_decoder[t] for t in encoded_nodes]

    # Identify subgraph scaffold
    index = re.findall('\d{1,}', sub_graphs_file)[0]
    scaffolds_file = scaffolds_dict[index]
    scaffold_path = os.path.join(scaffolds_path, scaffolds_file)
    scaffold = np.load(scaffold_path, allow_pickle=True)[()]

    nodes_in = []
    for terminal_predecessor in missing_terminals_predecessors:
        if terminal_predecessor in sub_graph_tasks:




            nodes_in.append(terminal_predecessor)
            print('predecessors of terminal predecessor {t}:'
                  .format(t=terminal_predecessor), list(sub_graph.predecessors(nodes_encoder[terminal_predecessor])))
    print('{n} missing terminal predecessors in subgraph {s}'.format(n=len(nodes_in), s=sub_graphs_file))